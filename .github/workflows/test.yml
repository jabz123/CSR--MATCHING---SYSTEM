name: PHP CI/CD (Build â€¢ Lint â€¢ Test â€¢ Deploy)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3

    - name: ğŸ§° Setup PHP 8.0
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'
        extensions: mbstring, pdo, pdo_mysql
        coverage: none
        tools: composer

    - name: ğŸ“¦ Install Composer dependencies (if composer.json exists)
      run: |
        if [ -f "composer.json" ]; then
          composer install --no-interaction --prefer-dist
        else
          echo "No composer.json found, skipping install"
        fi

    - name: âœ… Validate Composer config (if composer.json exists)
      run: |
        if [ -f "composer.json" ]; then
          composer validate --strict
        else
          echo "No composer.json found, skipping validation"
        fi

    - name: ğŸ” PHP Syntax Check (lint all files, show all errors)
      run: |
        echo "Scanning PHP files for syntax errors..."
        find . -type f -name "*.php" | while read file; do
          php -l "$file" || { echo "âŒ Syntax error in $file"; exit 1; }
        done
        echo "âœ… No syntax errors found."

    - name: ğŸ§ª Run PHPUnit Tests (if tests exist)
      run: |
        if [ -d "tests" ]; then
          if [ -f "vendor/bin/phpunit" ]; then
            vendor/bin/phpunit --testdox
          else
            echo "PHPUnit not found. Install it via Composer."
            exit 1
          fi
        else
          echo "No tests found, skipping PHPUnit."
        fi

  deploy:
    needs: build   # â— Only run if build job succeeds
    runs-on: ubuntu-latest

    steps:
    - name: ğŸš€ Mock Deployment
      run: |
        echo "âœ… Build successful!"
        echo "ğŸš€ Starting deployment..."
        echo "ğŸ“¦ Packaging application..."
        sleep 2
        echo "ğŸ“¤ Uploading to mock server..."
        sleep 2
        echo "ğŸ‰ Deployment completed successfully (Mock Deploy)."
